# Azure DevOps Pipeline - Build Only (Runtime + Backend)
# Deploys to E:\BIZUITSites\arielsch\arielschBIZUITCustomForms (runtime) and arielschBIZUITCustomFormsBackEnd (backend)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - custom-forms/**
      - azure-pipelines-build.yml

variables:
  # Node.js and Python versions
  nodeVersion: '22.x'
  pythonVersion: '3.12'

  # Deployment paths
  runtimeDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomForms'
  backendDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomFormsBackEnd'

  # PM2 app names
  pm2RuntimeApp: 'arielsch-runtime'
  pm2BackendApp: 'arielsch-backend'

  # Base path for Next.js
  basePath: '/arielschBIZUITCustomForms'

stages:
  # ==========================================================================
  # STAGE 1: Build Runtime App (Next.js)
  # ==========================================================================
  - stage: BuildRuntime
    displayName: 'Build Runtime App (Next.js)'
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildRuntimeJob
        displayName: 'Build Next.js Standalone'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/node_modules'
            displayName: 'Cache npm dependencies'

          - script: |
              cd custom-forms/runtime-app
              npm ci
            displayName: 'Install Runtime Dependencies'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              script: |
                Write-Host "Creating .env.local for build..."

                # Build-time environment variables
                "# Build-time configuration" | Out-File -FilePath ".env.local" -Encoding utf8
                "NEXT_PUBLIC_BASE_PATH=$(basePath)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_FORMS_API_URL=/api/bizuit" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_DASHBOARD_API_URL=/api/bizuit" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_SESSION_TIMEOUT_MINUTES=30" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "# Runtime configuration" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "FASTAPI_URL=http://localhost:8000" | Out-File -FilePath ".env.local" -Append -Encoding utf8

                Write-Host "âœ“ .env.local created successfully"
            displayName: 'Create Build Environment Configuration'

          - task: Cache@2
            inputs:
              key: 'nextjs | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json'
              restoreKeys: |
                nextjs | "$(Agent.OS)"
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/.next/cache'
            displayName: 'Cache Next.js build'

          - script: |
              cd custom-forms/runtime-app
              npm run build
            displayName: 'Build Next.js Application (Standalone Mode)'
            env:
              NODE_ENV: 'production'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              Contents: |
                .next/**
                public/**
                package.json
                server.js
                web.config.production
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/runtime-app'
            displayName: 'Copy Runtime Build Files'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'runtime-drop'
              publishLocation: 'Container'
            displayName: 'Publish Runtime Artifacts'

  # ==========================================================================
  # STAGE 2: Build Backend API (FastAPI)
  # ==========================================================================
  - stage: BuildBackend
    displayName: 'Build Backend API (FastAPI)'
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildBackendJob
        displayName: 'Prepare FastAPI Backend'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              cd custom-forms/backend-api
              pip install --upgrade pip
              pip install -r requirements.txt --target ./libs
            displayName: 'Install Python Dependencies to libs/'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                **/*.py
                requirements.txt
                web.config.production
                libs/**
                migrations/**
                !venv/**
                !__pycache__/**
                !*.pyc
                !.env
                !.env.local
                !tests/**
                !test_*.py
              TargetFolder: '$(Build.ArtifactStagingDirectory)/backend-api'
            displayName: 'Copy Backend Files'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                migrations/**/*.sql
              TargetFolder: '$(Build.ArtifactStagingDirectory)/migrations'
            displayName: 'Copy SQL Migration Scripts'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend-api'
              ArtifactName: 'backend-drop'
              publishLocation: 'Container'
            displayName: 'Publish Backend Artifacts'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/migrations'
              ArtifactName: 'migrations-drop'
              publishLocation: 'Container'
            displayName: 'Publish Migration Scripts (separate artifact)'
