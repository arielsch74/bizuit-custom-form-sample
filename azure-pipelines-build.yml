# Azure DevOps Pipeline - Build Only (Runtime + .NET Backend) - OPTIMIZED
# Deploys to E:\BIZUITSites\arielsch\arielschBIZUITCustomForms (runtime) and arielschBIZUITCustomFormsBackEndDotNet (backend)
#
# OPTIMIZATIONS:
# 1. Parallel execution of BuildRuntime and BuildBackend stages
# 2. Enhanced caching for npm and Next.js packages
# 3. Reduced artifact size by excluding unnecessary files
# 4. Faster npm install with --prefer-offline flag
# 5. .NET publish creates deployment-ready output

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - custom-forms/runtime-app/**
      - custom-forms/backend-api-dotnet/**
      - custom-forms/backend-api/migrations/**
      - azure-pipelines-build.yml

variables:
  # Framework versions
  nodeVersion: '22.x'
  dotnetVersion: '8.x'

  # Deployment paths
  runtimeDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomForms'
  backendDotNetDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomFormsBackEndDotNet'

  # PM2 app names (for runtime only)
  pm2RuntimeApp: 'arielsch-runtime'

  # Base path for Next.js
  basePath: '/arielschBIZUITCustomForms'

  # Standalone Forms (Iframe) Configuration
  allowedIframeOrigins: 'https://test.bizuit.com,https://*.bizuit.com'
  allowLocalhostIframe: 'false'

stages:
  # ==========================================================================
  # STAGE 1: Build Runtime App (Next.js) - PARALLEL with Backend
  # ==========================================================================
  - stage: BuildRuntime
    displayName: 'Build Runtime App (Next.js)'
    dependsOn: []  # ⚡ No dependencies - run in PARALLEL
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildRuntimeJob
        displayName: 'Build Next.js Standalone'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          # ⚡ OPTIMIZATION: Cache node_modules (more aggressive caching)
          - task: Cache@2
            inputs:
              key: 'npm-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json'
              restoreKeys: |
                npm-v2 | "$(Agent.OS)"
                npm-v2
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/node_modules'
            displayName: 'Cache npm dependencies'

          # ⚡ OPTIMIZATION: Use --prefer-offline when cache exists
          - script: |
              cd custom-forms/runtime-app
              if exist node_modules (
                echo "Cache hit - using --prefer-offline"
                npm ci --prefer-offline
              ) else (
                echo "No cache - full install"
                npm ci
              )
            displayName: 'Install Runtime Dependencies (Optimized)'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              script: |
                Write-Host "Creating .env.local for build..."

                # Build-time environment variables (MUST use absolute URLs)
                "# Build-time configuration" | Out-File -FilePath ".env.local" -Encoding utf8
                "NEXT_PUBLIC_BASE_PATH=$(basePath)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_DASHBOARD_API_URL=https://test.bizuit.com/arielschbizuitdashboardapi/api" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_FORMS_API_URL=https://test.bizuit.com/arielschBIZUITCustomFormsBackendDotNet" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_SESSION_TIMEOUT_MINUTES=30" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "# Standalone Forms (Iframe) Configuration" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_ALLOWED_IFRAME_ORIGINS=$(allowedIframeOrigins)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_ALLOW_LOCALHOST_IFRAME=$(allowLocalhostIframe)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "# Runtime configuration (server-side only - .NET backend)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "FASTAPI_URL=https://test.bizuit.com/arielschBIZUITCustomFormsBackendDotNet" | Out-File -FilePath ".env.local" -Append -Encoding utf8

                Write-Host "✓ .env.local created successfully"
            displayName: 'Create Build Environment Configuration'

          # ⚡ OPTIMIZATION: Cache Next.js build output
          - task: Cache@2
            inputs:
              key: 'nextjs-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json | custom-forms/runtime-app/**/*.ts | custom-forms/runtime-app/**/*.tsx'
              restoreKeys: |
                nextjs-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json
                nextjs-v2 | "$(Agent.OS)"
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/.next/cache'
            displayName: 'Cache Next.js build'

          - script: |
              cd custom-forms/runtime-app
              npm run build
            displayName: 'Build Next.js Application (Standalone Mode)'
            env:
              NODE_ENV: 'production'

          # ⚡ OPTIMIZATION: Only copy necessary files (exclude cache, reduce artifact size)
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              Contents: |
                .next/standalone/**
                .next/static/**
                .next/BUILD_ID
                public/**
                package.json
                server.js
                web.config.production
                scripts/prepare-deployment.js
                scripts/prepare-deployment.ps1
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/runtime-app'
            displayName: 'Copy Runtime Build Files (Optimized)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'runtime-drop'
              publishLocation: 'Container'
            displayName: 'Publish Runtime Artifacts'

  # ==========================================================================
  # STAGE 2: Build Backend API (.NET Core) - PARALLEL with Runtime
  # ==========================================================================
  - stage: BuildBackend
    displayName: 'Build Backend API (.NET Core)'
    dependsOn: []  # ⚡ No dependencies - run in PARALLEL
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildBackendJob
        displayName: 'Build .NET Core Backend'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          # Install .NET SDK
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              version: '8.x'
              installationPath: $(Agent.ToolsDirectory)/dotnet
            displayName: 'Install .NET 8 SDK'

          # Restore NuGet packages
          - task: DotNetCoreCLI@2
            inputs:
              command: 'restore'
              projects: 'custom-forms/backend-api-dotnet/BizuitCustomForms.WebApi/BizuitCustomForms.WebApi.csproj'
            displayName: 'Restore NuGet Packages'

          # Build .NET project
          - task: DotNetCoreCLI@2
            inputs:
              command: 'build'
              projects: 'custom-forms/backend-api-dotnet/BizuitCustomForms.WebApi/BizuitCustomForms.WebApi.csproj'
              arguments: '--configuration Release --no-restore'
            displayName: 'Build .NET Backend'

          # Publish .NET application (creates deployment-ready output)
          - task: DotNetCoreCLI@2
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: 'custom-forms/backend-api-dotnet/BizuitCustomForms.WebApi/BizuitCustomForms.WebApi.csproj'
              arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)/backend-dotnet --no-restore --no-build'
              zipAfterPublish: false
            displayName: 'Publish .NET Backend'

          # Copy SQL Migration Scripts (from Python backend, still used)
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                migrations/**/*.sql
              TargetFolder: '$(Build.ArtifactStagingDirectory)/migrations'
            displayName: 'Copy SQL Migration Scripts'

          # Publish .NET backend artifacts
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend-dotnet'
              ArtifactName: 'backend-dotnet-drop'
              publishLocation: 'Container'
            displayName: 'Publish .NET Backend Artifacts'

          # Publish Migration Scripts (separate artifact)
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/migrations'
              ArtifactName: 'migrations-drop'
              publishLocation: 'Container'
            displayName: 'Publish Migration Scripts'
