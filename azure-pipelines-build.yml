# Azure DevOps Pipeline - Build Only (Runtime + Backend) - OPTIMIZED
# Deploys to E:\BIZUITSites\arielsch\arielschBIZUITCustomForms (runtime) and arielschBIZUITCustomFormsBackEnd (backend)
#
# OPTIMIZATIONS:
# 1. Parallel execution of BuildRuntime and BuildBackend stages
# 2. Enhanced caching for npm, Next.js, and pip packages
# 3. Reduced artifact size by excluding unnecessary files
# 4. Faster npm install with --prefer-offline flag

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - custom-forms/**
      - azure-pipelines-build.yml

variables:
  # Node.js and Python versions
  nodeVersion: '22.x'
  pythonVersion: '3.12'

  # Deployment paths
  runtimeDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomForms'
  backendDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomFormsBackEnd'

  # PM2 app names
  pm2RuntimeApp: 'arielsch-runtime'
  pm2BackendApp: 'arielsch-backend'

  # Base path for Next.js
  basePath: '/arielschBIZUITCustomForms'

stages:
  # ==========================================================================
  # STAGE 1: Build Runtime App (Next.js) - PARALLEL with Backend
  # ==========================================================================
  - stage: BuildRuntime
    displayName: 'Build Runtime App (Next.js)'
    dependsOn: []  # ⚡ No dependencies - run in PARALLEL
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildRuntimeJob
        displayName: 'Build Next.js Standalone'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          # ⚡ OPTIMIZATION: Cache node_modules (more aggressive caching)
          - task: Cache@2
            inputs:
              key: 'npm-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json'
              restoreKeys: |
                npm-v2 | "$(Agent.OS)"
                npm-v2
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/node_modules'
            displayName: 'Cache npm dependencies'

          # ⚡ OPTIMIZATION: Use --prefer-offline when cache exists
          - script: |
              cd custom-forms/runtime-app
              if exist node_modules (
                echo "Cache hit - using --prefer-offline"
                npm ci --prefer-offline
              ) else (
                echo "No cache - full install"
                npm ci
              )
            displayName: 'Install Runtime Dependencies (Optimized)'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              script: |
                Write-Host "Creating .env.local for build..."

                # Build-time environment variables (MUST use absolute URLs)
                "# Build-time configuration" | Out-File -FilePath ".env.local" -Encoding utf8
                "NEXT_PUBLIC_BASE_PATH=$(basePath)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_DASHBOARD_API_URL=https://test.bizuit.com/arielschbizuitdashboardapi/api" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_FORMS_API_URL=https://test.bizuit.com/arielschBIZUITCustomFormsbackend" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_SESSION_TIMEOUT_MINUTES=30" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_ALLOW_DEV_MODE=false" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "# Runtime configuration (server-side only)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "FASTAPI_URL=http://127.0.0.1:8000" | Out-File -FilePath ".env.local" -Append -Encoding utf8

                Write-Host "✓ .env.local created successfully"
            displayName: 'Create Build Environment Configuration'

          # ⚡ OPTIMIZATION: Cache Next.js build output
          - task: Cache@2
            inputs:
              key: 'nextjs-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json | custom-forms/runtime-app/**/*.ts | custom-forms/runtime-app/**/*.tsx'
              restoreKeys: |
                nextjs-v2 | "$(Agent.OS)" | custom-forms/runtime-app/package-lock.json
                nextjs-v2 | "$(Agent.OS)"
              path: '$(Build.SourcesDirectory)/custom-forms/runtime-app/.next/cache'
            displayName: 'Cache Next.js build'

          - script: |
              cd custom-forms/runtime-app
              npm run build
            displayName: 'Build Next.js Application (Standalone Mode)'
            env:
              NODE_ENV: 'production'

          # ⚡ OPTIMIZATION: Only copy necessary files (exclude cache, reduce artifact size)
          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              Contents: |
                .next/standalone/**
                .next/static/**
                .next/BUILD_ID
                public/**
                package.json
                server.js
                web.config.production
                scripts/prepare-deployment.js
                scripts/prepare-deployment.ps1
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/runtime-app'
            displayName: 'Copy Runtime Build Files (Optimized)'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'runtime-drop'
              publishLocation: 'Container'
            displayName: 'Publish Runtime Artifacts'

  # ==========================================================================
  # STAGE 2: Build Backend API (FastAPI) - PARALLEL with Runtime
  # ==========================================================================
  - stage: BuildBackend
    displayName: 'Build Backend API (FastAPI)'
    dependsOn: []  # ⚡ No dependencies - run in PARALLEL
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildBackendJob
        displayName: 'Prepare FastAPI Backend'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          # ⚡ OPTIMIZATION: Skip libs installation in build
          # Dependencies will be installed during deployment (faster artifact publish)
          # This reduces artifact size from ~200MB to ~2MB

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                **/*.py
                requirements.txt
                web.config.production
                migrations/**
                !venv/**
                !libs/**
                !__pycache__/**
                !*.pyc
                !.env
                !.env.local
                !tests/**
                !test_*.py
              TargetFolder: '$(Build.ArtifactStagingDirectory)/backend-api'
            displayName: 'Copy Backend Files (Source Only - No libs)'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                migrations/**/*.sql
              TargetFolder: '$(Build.ArtifactStagingDirectory)/migrations'
            displayName: 'Copy SQL Migration Scripts'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/backend-api'
              ArtifactName: 'backend-drop'
              publishLocation: 'Container'
            displayName: 'Publish Backend Artifacts'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/migrations'
              ArtifactName: 'migrations-drop'
              publishLocation: 'Container'
            displayName: 'Publish Migration Scripts (separate artifact)'
