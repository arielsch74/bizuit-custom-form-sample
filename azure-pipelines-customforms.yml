# Azure DevOps Pipeline for BIZUIT Custom Forms (Runtime + Backend)
# Deploys to E:\BIZUITSites\arielsch\arielschBIZUITCustomForms (runtime) and arielschBIZUITCustomFormsBackEnd (backend)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - custom-forms/**
      - azure-pipelines-customforms.yml

variables:
  # Node.js and Python versions
  nodeVersion: '22.x'
  pythonVersion: '3.12'

  # Deployment paths
  runtimeDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomForms'
  backendDeployPath: 'E:\BIZUITSites\arielsch\arielschBIZUITCustomFormsBackEnd'

  # PM2 app names
  pm2RuntimeApp: 'arielsch-runtime'
  pm2BackendApp: 'arielsch-backend'

  # Base path for Next.js
  basePath: '/arielschBIZUITCustomForms'

stages:
  # ==========================================================================
  # STAGE 1: Build Runtime App (Next.js)
  # ==========================================================================
  - stage: BuildRuntime
    displayName: 'Build Runtime App (Next.js)'
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildRuntimeJob
        displayName: 'Build Next.js Standalone'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          - script: |
              cd custom-forms/runtime-app
              npm ci
            displayName: 'Install Runtime Dependencies'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              workingDirectory: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              script: |
                Write-Host "Creating .env.local for build..."

                # Build-time environment variables
                "# Build-time configuration" | Out-File -FilePath ".env.local" -Encoding utf8
                "NEXT_PUBLIC_BASE_PATH=$(basePath)" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_FORMS_API_URL=/api/bizuit" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_BIZUIT_DASHBOARD_API_URL=/api/bizuit" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "NEXT_PUBLIC_SESSION_TIMEOUT_MINUTES=30" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "# Runtime configuration" | Out-File -FilePath ".env.local" -Append -Encoding utf8
                "FASTAPI_URL=http://localhost:8000" | Out-File -FilePath ".env.local" -Append -Encoding utf8

                Write-Host "✓ .env.local created successfully"
            displayName: 'Create Build Environment Configuration'

          - script: |
              cd custom-forms/runtime-app
              npm run build
            displayName: 'Build Next.js Application (Standalone Mode)'
            env:
              NODE_ENV: 'production'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/runtime-app'
              Contents: |
                .next/**
                public/**
                package.json
                server.js
                web.config.production
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/runtime-app'
            displayName: 'Copy Runtime Build Files'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'runtime-drop'
              publishLocation: 'Container'
            displayName: 'Publish Runtime Artifacts'

  # ==========================================================================
  # STAGE 2: Build Backend API (FastAPI)
  # ==========================================================================
  - stage: BuildBackend
    displayName: 'Build Backend API (FastAPI)'
    pool:
      vmImage: 'windows-latest'
    jobs:
      - job: BuildBackendJob
        displayName: 'Prepare FastAPI Backend'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              cd custom-forms/backend-api
              pip install --upgrade pip
              pip install -r requirements.txt --target ./libs
            displayName: 'Install Python Dependencies to libs/'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/custom-forms/backend-api'
              Contents: |
                **/*.py
                requirements.txt
                libs/**
                migrations/**
                !venv/**
                !__pycache__/**
                !*.pyc
                !.env
                !.env.local
                !tests/**
                !test_*.py
              TargetFolder: '$(Build.ArtifactStagingDirectory)/backend-api'
            displayName: 'Copy Backend Files'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'backend-drop'
              publishLocation: 'Container'
            displayName: 'Publish Backend Artifacts'

  # ==========================================================================
  # STAGE 3: Run Database Migrations
  # ==========================================================================
  - stage: RunMigrations
    displayName: 'Run Database Migrations'
    dependsOn: BuildBackend
    condition: succeeded()
    pool:
      name: Testbizuitcom  # Self-hosted agent
    jobs:
      - job: MigrationsJob
        displayName: 'Execute SQL Migrations'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'backend-drop'
              downloadPath: '$(System.ArtifactsDirectory)'
            displayName: 'Download Backend Artifacts'

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "=== Running Database Migrations ===" -ForegroundColor Cyan

                $migrationsPath = "$(System.ArtifactsDirectory)\backend-drop\backend-api\migrations"

                if (-not (Test-Path $migrationsPath)) {
                    Write-Host "⚠️  No migrations directory found" -ForegroundColor Yellow
                    Write-Host "Skipping migrations..."
                    exit 0
                }

                # Get all SQL files in migrations directory
                $sqlFiles = Get-ChildItem -Path $migrationsPath -Filter "*.sql" | Sort-Object Name

                if ($sqlFiles.Count -eq 0) {
                    Write-Host "⚠️  No SQL migration files found" -ForegroundColor Yellow
                    exit 0
                }

                Write-Host "Found $($sqlFiles.Count) migration file(s)" -ForegroundColor Green

                # Read connection string from .env.local (already exists on server)
                $envPath = "$(backendDeployPath)\.env.local"

                if (-not (Test-Path $envPath)) {
                    Write-Error "❌ .env.local not found at: $envPath"
                    Write-Error "Migrations require database credentials from .env.local"
                    exit 1
                }

                Write-Host "Reading database configuration from .env.local..." -ForegroundColor Gray

                # Parse .env.local
                $envVars = @{}
                Get-Content $envPath | ForEach-Object {
                    if ($_ -match '^([^#][^=]+)=(.+)$') {
                        $envVars[$matches[1].Trim()] = $matches[2].Trim()
                    }
                }

                $dbServer = $envVars['DB_SERVER']
                $dbDatabase = $envVars['DB_DATABASE']
                $dbUser = $envVars['DB_USER']
                $dbPassword = $envVars['DB_PASSWORD']

                if (-not $dbServer -or -not $dbDatabase) {
                    Write-Error "❌ Missing database configuration in .env.local"
                    exit 1
                }

                Write-Host "Target Database: $dbServer\$dbDatabase" -ForegroundColor Gray

                # Build connection string
                $connectionString = "Server=$dbServer;Database=$dbDatabase;User Id=$dbUser;Password=$dbPassword;TrustServerCertificate=True;Encrypt=True;"

                # Execute each migration file
                foreach ($file in $sqlFiles) {
                    Write-Host "`n--- Executing: $($file.Name) ---" -ForegroundColor Yellow

                    try {
                        # Use sqlcmd to execute the migration
                        $sqlcmd = "sqlcmd"
                        $arguments = @(
                            "-S", $dbServer,
                            "-d", $dbDatabase,
                            "-U", $dbUser,
                            "-P", $dbPassword,
                            "-i", $file.FullName,
                            "-b"  # Exit with error code on SQL errors
                        )

                        $output = & $sqlcmd $arguments 2>&1

                        if ($LASTEXITCODE -eq 0) {
                            Write-Host "✓ Migration executed successfully" -ForegroundColor Green
                            Write-Host $output -ForegroundColor Gray
                        } else {
                            Write-Error "❌ Migration failed with exit code: $LASTEXITCODE"
                            Write-Error $output
                            exit 1
                        }
                    } catch {
                        Write-Error "❌ Error executing migration: $_"
                        exit 1
                    }
                }

                Write-Host "`n=== All Migrations Completed Successfully ===" -ForegroundColor Green
            displayName: 'Execute Idempotent SQL Migrations'

  # ==========================================================================
  # STAGE 4: Deploy Runtime App
  # ==========================================================================
  - stage: DeployRuntime
    displayName: 'Deploy Runtime App'
    dependsOn:
      - BuildRuntime
      - RunMigrations
    condition: succeeded()
    pool:
      name: Testbizuitcom
    jobs:
      - deployment: DeployRuntimeJob
        displayName: 'Deploy Next.js to PM2'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'runtime-drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download Runtime Artifacts'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Stopping PM2 process: $(pm2RuntimeApp)"
                      pm2 stop $(pm2RuntimeApp) 2>&1 | Out-Null
                      Write-Host "✓ Process stopped (or was not running)"
                  displayName: 'Stop PM2 Runtime Process'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Preparing deployment directory..."

                      # Clean deployment directory (preserve .env.local and logs)
                      if (Test-Path "$(runtimeDeployPath)") {
                          Write-Host "Cleaning deployment directory..."
                          Get-ChildItem "$(runtimeDeployPath)" -Exclude @('.env.local', 'logs') | Remove-Item -Recurse -Force
                      } else {
                          Write-Host "Creating deployment directory..."
                          New-Item -ItemType Directory -Path "$(runtimeDeployPath)" -Force | Out-Null
                      }

                      # Ensure logs directory exists
                      New-Item -ItemType Directory -Path "$(runtimeDeployPath)\logs" -Force -ErrorAction SilentlyContinue | Out-Null

                      Write-Host "✓ Deployment directory prepared"
                  displayName: 'Prepare Deployment Directory'

                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.ArtifactsDirectory)/runtime-drop/runtime-app'
                    Contents: '**'
                    TargetFolder: '$(runtimeDeployPath)'
                    OverWrite: true
                  displayName: 'Copy Runtime Files'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(runtimeDeployPath)'
                    script: |
                      Write-Host "Configuring runtime app for production..."

                      # Copy production web.config
                      if (Test-Path "web.config.production") {
                          Copy-Item "web.config.production" "web.config" -Force
                          Write-Host "✓ web.config.production copied as web.config"
                      } else {
                          Write-Warning "⚠️  web.config.production not found"
                      }

                      # Install production dependencies
                      Write-Host "Installing production dependencies..."
                      npm ci --production

                      Write-Host "✓ Runtime app configured"
                  displayName: 'Configure Runtime App'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Starting PM2 process: $(pm2RuntimeApp)"

                      # Try to restart (if exists) or start (if new)
                      pm2 restart $(pm2RuntimeApp) 2>&1 | Out-Null

                      if ($LASTEXITCODE -ne 0) {
                          Write-Host "Process not found, starting new instance..."
                          pm2 start E:\BIZUITSites\arielsch\ecosystem.config.js --only $(pm2RuntimeApp)
                      }

                      # Save PM2 configuration
                      pm2 save --force

                      Write-Host "✓ PM2 process started"
                  displayName: 'Start PM2 Runtime Process'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Health check: Testing runtime app..."

                      $maxAttempts = 10
                      $success = $false

                      for ($i = 1; $i -le $maxAttempts; $i++) {
                          Write-Host "Attempt $i of $maxAttempts..."
                          Start-Sleep -Seconds 5

                          try {
                              $response = Invoke-WebRequest -Uri "http://localhost:3001" -UseBasicParsing -TimeoutSec 10
                              if ($response.StatusCode -eq 200) {
                                  Write-Host "✅ Runtime app is healthy!" -ForegroundColor Green
                                  $success = $true
                                  break
                              }
                          } catch {
                              Write-Host "Not ready: $($_.Exception.Message)" -ForegroundColor DarkGray
                          }
                      }

                      if (-not $success) {
                          Write-Host "`n=== PM2 Logs ===" -ForegroundColor Red
                          pm2 logs $(pm2RuntimeApp) --lines 50 --nostream
                          Write-Error "❌ Runtime app failed health check"
                          exit 1
                      }
                  displayName: 'Runtime Health Check'

  # ==========================================================================
  # STAGE 5: Deploy Backend API
  # ==========================================================================
  - stage: DeployBackend
    displayName: 'Deploy Backend API'
    dependsOn:
      - BuildBackend
      - RunMigrations
    condition: succeeded()
    pool:
      name: Testbizuitcom
    jobs:
      - deployment: DeployBackendJob
        displayName: 'Deploy FastAPI to PM2'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'backend-drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download Backend Artifacts'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Stopping PM2 process: $(pm2BackendApp)"
                      pm2 stop $(pm2BackendApp) 2>&1 | Out-Null
                      Write-Host "✓ Process stopped (or was not running)"
                  displayName: 'Stop PM2 Backend Process'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Preparing deployment directory..."

                      # Clean deployment directory (preserve .env.local and logs)
                      if (Test-Path "$(backendDeployPath)") {
                          Write-Host "Cleaning deployment directory..."
                          Get-ChildItem "$(backendDeployPath)" -Exclude @('.env.local', 'logs', 'temp-uploads') | Remove-Item -Recurse -Force
                      } else {
                          Write-Host "Creating deployment directory..."
                          New-Item -ItemType Directory -Path "$(backendDeployPath)" -Force | Out-Null
                      }

                      # Ensure required directories exist
                      New-Item -ItemType Directory -Path "$(backendDeployPath)\logs" -Force -ErrorAction SilentlyContinue | Out-Null
                      New-Item -ItemType Directory -Path "$(backendDeployPath)\temp-uploads" -Force -ErrorAction SilentlyContinue | Out-Null

                      Write-Host "✓ Deployment directory prepared"
                  displayName: 'Prepare Deployment Directory'

                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.ArtifactsDirectory)/backend-drop/backend-api'
                    Contents: '**'
                    TargetFolder: '$(backendDeployPath)'
                    OverWrite: true
                  displayName: 'Copy Backend Files'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(backendDeployPath)'
                    script: |
                      Write-Host "Configuring backend API for production..."

                      # Verify .env.local exists (should be manually created on server)
                      if (-not (Test-Path ".env.local")) {
                          Write-Warning "⚠️  .env.local not found!"
                          Write-Warning "Backend will not have configuration."
                          Write-Warning "Create .env.local manually on server with production secrets."
                      } else {
                          Write-Host "✓ .env.local found"
                      }

                      # Move installed libs to Python path (if using libs folder)
                      if (Test-Path "libs") {
                          Write-Host "Python dependencies installed in libs/"
                      }

                      Write-Host "✓ Backend API configured"
                  displayName: 'Configure Backend API'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Starting PM2 process: $(pm2BackendApp)"

                      # Set environment variable for production mode
                      $env:PYTHON_ENV = "production"

                      # Try to restart (if exists) or start (if new)
                      pm2 restart $(pm2BackendApp) 2>&1 | Out-Null

                      if ($LASTEXITCODE -ne 0) {
                          Write-Host "Process not found, starting new instance..."
                          pm2 start E:\BIZUITSites\arielsch\ecosystem.config.js --only $(pm2BackendApp)
                      }

                      # Save PM2 configuration
                      pm2 save --force

                      Write-Host "✓ PM2 process started"
                  displayName: 'Start PM2 Backend Process'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Health check: Testing backend API..."

                      $maxAttempts = 10
                      $success = $false

                      for ($i = 1; $i -le $maxAttempts; $i++) {
                          Write-Host "Attempt $i of $maxAttempts..."
                          Start-Sleep -Seconds 5

                          try {
                              $response = Invoke-WebRequest -Uri "http://localhost:8000/api/health" -UseBasicParsing -TimeoutSec 10
                              if ($response.StatusCode -eq 200) {
                                  Write-Host "✅ Backend API is healthy!" -ForegroundColor Green
                                  $success = $true
                                  break
                              }
                          } catch {
                              Write-Host "Not ready: $($_.Exception.Message)" -ForegroundColor DarkGray
                          }
                      }

                      if (-not $success) {
                          Write-Host "`n=== PM2 Logs ===" -ForegroundColor Red
                          pm2 logs $(pm2BackendApp) --lines 50 --nostream
                          Write-Error "❌ Backend API failed health check"
                          exit 1
                      }
                  displayName: 'Backend Health Check'
