# Azure DevOps Pipeline for BIZUIT Custom Forms Sample
# Deploys Next.js application to E:\DevSites\BIZUITCustomForms

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - example/**
      - packages/**
      - azure-pipelines.yml

pool:
  name: DARPrestamosAgentPool

variables:
  nodeVersion: '22.x'
  deployPath: 'E:\DevSites\BIZUITCustomForms'
  appName: 'bizuit-custom-forms'
  appPort: 3000
  basePath: '/BIZUITCustomForms'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Build Next.js App'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          - script: |
              cd example
              npm ci
            displayName: 'Install Dependencies'

          - script: |
              cd example
              npm run build
            displayName: 'Build Next.js Application'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/example'
              Contents: |
                **/*
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/example'
            displayName: 'Copy Build Files'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifacts'

  - stage: Deploy
    displayName: 'Deploy to Server'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy Next.js App'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download Build Artifacts'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Stopping PM2 application: $(appName)"

                      # Check if PM2 is installed
                      $pm2Path = "$env:APPDATA\npm\pm2.cmd"
                      if (-not (Test-Path $pm2Path)) {
                          Write-Host "PM2 not installed. Installing PM2 globally..."
                          npm install -g pm2
                          Write-Host "PM2 installed successfully"
                      } else {
                          Write-Host "PM2 is already installed"
                      }

                      # Refresh PATH to include npm global binaries
                      $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

                      # Stop and delete existing PM2 process if exists
                      try {
                          $pmList = & pm2 list 2>&1 | Out-String
                          if ($pmList -match "$(appName)") {
                              Write-Host "Stopping existing PM2 process..."
                              & pm2 stop $(appName)
                              & pm2 delete $(appName)
                          } else {
                              Write-Host "No existing PM2 process found."
                          }
                      } catch {
                          Write-Host "PM2 process check skipped (first deployment or PM2 not configured)"
                      }

                      # Clean deployment directory
                      if (Test-Path "$(deployPath)") {
                          Write-Host "Cleaning deployment directory..."
                          Remove-Item "$(deployPath)\*" -Recurse -Force -ErrorAction SilentlyContinue
                      } else {
                          Write-Host "Creating deployment directory..."
                          New-Item -ItemType Directory -Path "$(deployPath)" -Force
                      }
                  displayName: 'Stop PM2 Application'

                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.ArtifactsDirectory)/drop/example'
                    Contents: '**'
                    TargetFolder: '$(deployPath)'
                    OverWrite: true
                  displayName: 'Copy Files to Deployment Directory'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(deployPath)'
                    script: |
                      Write-Host "Installing production dependencies..."
                      npm ci --production

                      # Refresh PATH to include npm global binaries
                      $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

                      # Add npm global directory to PATH explicitly
                      $npmGlobalPath = npm config get prefix
                      if ($npmGlobalPath) {
                          $env:Path = "$npmGlobalPath;$env:Path"
                          Write-Host "NPM global path added: $npmGlobalPath"
                      }

                      # Verify PM2 is accessible
                      $pm2Command = Get-Command pm2 -ErrorAction SilentlyContinue
                      if (-not $pm2Command) {
                          Write-Host "PM2 not found in PATH. Installing PM2..."
                          npm install -g pm2
                          # Refresh PATH again after installation
                          $npmGlobalPath = npm config get prefix
                          $env:Path = "$npmGlobalPath;$env:Path"
                      }

                      Write-Host "PM2 location: $(Get-Command pm2 | Select-Object -ExpandProperty Source)"

                      Write-Host "Starting Next.js application with PM2..."
                      & pm2 start npm --name "$(appName)" -- start
                      & pm2 save

                      Write-Host "Deployment completed successfully!"
                      Write-Host "Application running on port $(appPort)"

                      # Show PM2 status
                      & pm2 list
                  displayName: 'Install Dependencies and Start Application'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Verifying deployment..."

                      # Refresh PATH to include npm global binaries
                      $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
                      $npmGlobalPath = npm config get prefix
                      if ($npmGlobalPath) {
                          $env:Path = "$npmGlobalPath;$env:Path"
                      }

                      # Check PM2 process status
                      Write-Host "`n=== PM2 Status ===" -ForegroundColor Cyan
                      & pm2 list

                      # Wait for Next.js to compile and start (can take 15-30 seconds)
                      Write-Host "`nWaiting for Next.js to start..." -ForegroundColor Yellow
                      $maxAttempts = 12
                      $attemptDelay = 5
                      $success = $false

                      for ($i = 1; $i -le $maxAttempts; $i++) {
                          Write-Host "Attempt $i of ${maxAttempts}..."
                          Start-Sleep -Seconds $attemptDelay

                          try {
                              $response = Invoke-WebRequest -Uri "http://localhost:$(appPort)$(basePath)/" -UseBasicParsing -TimeoutSec 5
                              if ($response.StatusCode -eq 200) {
                                  Write-Host "`n✅ Application is running successfully!" -ForegroundColor Green
                                  Write-Host "Status Code: $($response.StatusCode)"
                                  Write-Host "URL: http://localhost:$(appPort)$(basePath)/"
                                  Write-Host "Startup time: ~$($i * $attemptDelay) seconds"
                                  $success = $true
                                  break
                              }
                          } catch {
                              Write-Host "Not ready yet: $_" -ForegroundColor DarkGray
                          }
                      }

                      if (-not $success) {
                          Write-Host "`n=== PM2 Logs (Last 100 lines) ===" -ForegroundColor Red
                          & pm2 logs $(appName) --lines 100 --nostream

                          Write-Host "`n=== PM2 Process Info ===" -ForegroundColor Red
                          & pm2 show $(appName)

                          Write-Error "❌ Application failed to start after $($maxAttempts * $attemptDelay) seconds"
                          exit 1
                      }
                  displayName: 'Health Check'
