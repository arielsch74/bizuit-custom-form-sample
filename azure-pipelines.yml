# Azure DevOps Pipeline for BIZUIT Custom Forms Sample
# Deploys Next.js application to E:\DevSites\BIZUITCustomForms

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - example/**
      - packages/**
      - azure-pipelines.yml

pool:
  name: DARPrestamosAgentPool

variables:
  nodeVersion: '22.x'
  deployPath: 'E:\DevSites\BIZUITCustomForms'
  appName: 'bizuit-custom-forms'
  appPort: 3000
  basePath: '/BIZUITCustomForms'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Build Next.js App'
        steps:
          - checkout: self
            clean: 'true'
            displayName: 'Checkout Repository'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js $(nodeVersion)'

          - script: |
              cd example
              npm ci
            displayName: 'Install Dependencies'

          - script: |
              cd example
              npm run build
            displayName: 'Build Next.js Application'
            env:
              DEPLOY_ENV: 'production'

          - task: CopyFiles@2
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/example'
              Contents: |
                **/*
                !node_modules/**
                !.next/cache/**
              TargetFolder: '$(Build.ArtifactStagingDirectory)/example'
            displayName: 'Copy Build Files'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: 'Publish Build Artifacts'

  - stage: Deploy
    displayName: 'Deploy to Server'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy Next.js App'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download Build Artifacts'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Preparing deployment directory..."

                      # Stop IIS Application Pool to release file locks
                      $appPoolName = "DefaultAppPool"  # Adjust if using different app pool
                      Write-Host "Stopping Application Pool: $appPoolName"
                      try {
                          Stop-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
                          Start-Sleep -Seconds 3
                      } catch {
                          Write-Host "Could not stop app pool (may not exist yet): $_"
                      }

                      # Clean deployment directory
                      if (Test-Path "$(deployPath)") {
                          Write-Host "Cleaning deployment directory..."
                          Remove-Item "$(deployPath)\*" -Recurse -Force -ErrorAction SilentlyContinue
                      } else {
                          Write-Host "Creating deployment directory..."
                          New-Item -ItemType Directory -Path "$(deployPath)" -Force
                      }
                  displayName: 'Prepare Deployment Directory'

                - task: CopyFiles@2
                  inputs:
                    SourceFolder: '$(System.ArtifactsDirectory)/drop/example'
                    Contents: '**'
                    TargetFolder: '$(deployPath)'
                    OverWrite: true
                  displayName: 'Copy Files to Deployment Directory'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(deployPath)'
                    script: |
                      Write-Host "Creating .env.local file..."

                      # Create .env.local with Bizuit configuration
                      @"
                      # Bizuit API Configuration
                      # Use Next.js proxy to handle CORS and authentication headers
                      NEXT_PUBLIC_BIZUIT_FORMS_API_URL=/api/bizuit
                      NEXT_PUBLIC_BIZUIT_DASHBOARD_API_URL=/api/bizuit
                      NEXT_PUBLIC_BIZUIT_TIMEOUT=30000

                      # Token expiration time in minutes (default: 1440 minutes = 24 hours)
                      NEXT_PUBLIC_BIZUIT_TOKEN_EXPIRATION_MINUTES=1440

                      # Internal configuration for proxy (server-side only)
                      BIZUIT_API_BASE_URL=https://test.bizuit.com/arielschbizuitdashboardapi/api
                      "@ | Out-File -FilePath ".env.local" -Encoding utf8

                      Write-Host "✓ .env.local created successfully"
                  displayName: 'Create Environment Configuration'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    workingDirectory: '$(deployPath)'
                    script: |
                      Write-Host "Configuring IISNode deployment..."

                      # Copy the IISNode web.config
                      if (Test-Path "web.config.iisnode") {
                          Write-Host "Using IISNode web.config..."
                          Copy-Item "web.config.iisnode" "web.config" -Force
                      } else {
                          Write-Host "Warning: web.config.iisnode not found"
                      }

                      # Install production dependencies
                      Write-Host "Installing production dependencies..."
                      npm ci --production

                      # Verify server.js exists
                      if (Test-Path "server.js") {
                          Write-Host "✓ server.js found"
                      } else {
                          Write-Error "server.js not found! Deployment cannot continue."
                          exit 1
                      }

                      # Verify standalone build exists
                      if (Test-Path ".next/standalone") {
                          Write-Host "✓ Standalone build found"
                      } else {
                          Write-Host "Warning: .next/standalone not found (expected for Next.js standalone mode)"
                      }

                      # Start IIS Application Pool
                      $appPoolName = "DefaultAppPool"  # Adjust if using different app pool
                      Write-Host "Starting Application Pool: $appPoolName"
                      try {
                          Start-WebAppPool -Name $appPoolName -ErrorAction SilentlyContinue
                          Write-Host "✓ Application Pool started"
                      } catch {
                          Write-Host "Could not start app pool: $_"
                      }

                      Write-Host "Deployment completed successfully!"
                      Write-Host "IISNode will start the application on first request"
                  displayName: 'Configure IISNode Application'

                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Verifying IISNode deployment..."

                      # IISNode starts on first request, so we need to trigger it
                      Write-Host "`nTriggering IISNode startup..." -ForegroundColor Yellow
                      $maxAttempts = 15
                      $attemptDelay = 5
                      $success = $false

                      # Determine the URL to test
                      # Try localhost first (IISNode internal), then the actual URL
                      $testUrls = @(
                          "http://localhost$(basePath)/",
                          "http://test.bizuit.com$(basePath)/"
                      )

                      for ($i = 1; $i -le $maxAttempts; $i++) {
                          Write-Host "Attempt $i of ${maxAttempts}..."
                          Start-Sleep -Seconds $attemptDelay

                          foreach ($url in $testUrls) {
                              try {
                                  Write-Host "Testing: $url" -ForegroundColor DarkGray
                                  $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                                  if ($response.StatusCode -eq 200) {
                                      Write-Host "`n✅ Application is running successfully!" -ForegroundColor Green
                                      Write-Host "Status Code: $($response.StatusCode)"
                                      Write-Host "URL: $url"
                                      Write-Host "Startup time: ~$($i * $attemptDelay) seconds"
                                      $success = $true
                                      break
                                  }
                              } catch {
                                  Write-Host "Not ready: $($_.Exception.Message)" -ForegroundColor DarkGray
                              }
                          }

                          if ($success) { break }
                      }

                      if (-not $success) {
                          Write-Host "`n=== IISNode Logs ===" -ForegroundColor Red
                          $logPath = "$(deployPath)\iisnode"
                          if (Test-Path $logPath) {
                              Get-ChildItem $logPath -Filter "*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 3 | ForEach-Object {
                                  Write-Host "`n--- $($_.Name) ---" -ForegroundColor Yellow
                                  Get-Content $_.FullName -Tail 50
                              }
                          } else {
                              Write-Host "No IISNode logs found at: $logPath"
                          }

                          Write-Host "`n=== Application Pool Status ===" -ForegroundColor Red
                          Get-WebAppPoolState -Name "DefaultAppPool" -ErrorAction SilentlyContinue

                          Write-Error "❌ Application failed to start after $($maxAttempts * $attemptDelay) seconds"
                          Write-Host "`nTroubleshooting:"
                          Write-Host "1. Check IISNode logs in: $(deployPath)\iisnode"
                          Write-Host "2. Verify IISNode is installed"
                          Write-Host "3. Check Application Pool is running"
                          Write-Host "4. Try accessing: http://test.bizuit.com$(basePath)/"
                          exit 1
                      }
                  displayName: 'Health Check'
